# Troubleshooting

Just to document all the issues I've encountered that shouldn't happen anymore...  
Started doing this later than most of them, so some might be missing.

## Things that might be good to know when debugging
* U-boot initializes and loads files off of MMC/microSD, then we jump from u-boot into the kernel, where things get re-initialized again


## During build of tf-a
stm32mp151a-tios-mx-bl2.pre.dts:1321.3-4 syntax error
```c
 st,clkdiv = <
  DIV(DIV_MPU, 1) <<< syntax error here
  DIV(DIV_AXI, 0)
  DIV(DIV_MCU, 0)
  DIV(DIV_APB1, 1)
  DIV(DIV_APB2, 1)
  DIV(DIV_APB3, 1)
  DIV(DIV_APB4, 1)
  DIV(DIV_APB5, 2)
  DIV(DIV_RTC, 0)
  DIV(DIV_MCO1, 0)
  DIV(DIV_MCO2, 0)
 >;
```
This is because the stm32mp15_clsrc.h changed between mainline (2.9.0 at time of writing) and the ST version.
Overwriting mainline with ST version of this file fixed this.

## ERROR:   regul ldo3: max value 750 is invalid
```c
ERROR:   regul ldo3: max value 750 is invalid
WARNING: register_pmic:423 failed to register ldo3
```

### Cause
This wasn't an issue with old ECO but is now.
The likely reason is that the ldo's normal mode have a range from 1,8V to 3,3V but ldo3 has a 'sink source' mode that
sets the voltage to half of buck2 and that falls outside that range. The check doesn't take this in account and complains. 

### Fix 
Change the ldo3 node by removing the lines about the min/max.
```c
      vtt_ddr: ldo3 {
          regulator-name = "vtt_ddr";
          regulator-always-on;
          regulator-over-current-protection;
          st,regulator-sink-source;
      };
```

## ERROR:   DDR addr bus test: can't access memory @ 0xc8000000
```c
INFO:    BL2: Doing platform setup
INFO:    RAM: DDR3-DDR3L 16bits 533000kHz
ERROR:   DDR addr bus test: can't access memory @ 0xc8000000
PANIC at PC : 0x2ffead5d
```
### When?
During boot of TF-A.

### Cause?
Mismatch between old DT and new, for some reason `DDR_ADDRMAP6` value changed.  
The file generated by CubeMX has `#define DDR_ADDRMAP6 0x0F070706` but that value should be `0x0F060606`.
Because the file by CubeMX doesn't have the calibration values, maybe this is altered because of that?

Note that when investigation this issue you'll come accross this:  
https://github.com/ARM-software/arm-trusted-firmware/blob/master/drivers/st/ddr/stm32mp_ddr_test.c

That points to a hardware issue 'Check for address bits stuck high.' but I gues this has other causes.

### Fix
As mentioned change the line about `DDR_ADDRMAP6`
```c
#define DDR_ADDRMAP6 0x0F060606
```
And maybe add/check the calibration values.

## E/TC:0 0 Panic at core/arch/arm/plat-stm32mp1/cpu_opp.c:106 <set_clock_then_voltage>
```c
D/TC:0 0 stm32mp1_cpu_opp_get_dt_subnode:291 Found OPP 0 (650000kHz/1200mV) from DT
F/TC:0 0 regulator_set_voltage:299 vddcore 1200mV
E/TC:0 0 Panic at core/arch/arm/plat-stm32mp1/cpu_opp.c:106 <set_clock_then_voltage>
```
> Note: Optee debug log level needs to be at four (or atleast higher than two).

### When?
This happens during the boot of OPTEE.

### Cause?
Unsure, but this is part of the pmic setup
```c
      vddcore: buck1 {
          regulator-name = "vddcore";
          regulator-min-microvolt = <1200000>;
          regulator-max-microvolt = <1350000>;
          regulator-always-on;
          regulator-initial-mode = <0>;
          regulator-over-current-protection;
      };
```
Compared to this node in root USER CODE
```c
	vddcore: vddcore {
		compatible = "regulator-fixed";
		regulator-name = "vddcore";
		regulator-min-microvolt = <1350000>; 
		regulator-max-microvolt = <1350000>;
		regulator-always-on;
	};
```
So maybe the reason is a mismatch?

### Fix
Altering the node inside the root USER CODE of the optee DT.
```c
	vddcore: vddcore {
		compatible = "regulator-fixed";
		regulator-name = "vddcore";
		regulator-min-microvolt = <1200000>; // Changed from 1350000
		regulator-max-microvolt = <1350000>;
		regulator-always-on;
	};
```

## ERROR: Could NOT find the fip partition
```c
NOTICE:  Model: STMicroelectronics custom STM32CubeMX board - openstlinux-6.1-yocto-mickledore-mp1-v23.06.21
NOTICE:  BL2: v2.8-stm32mp1-r1.0(release):v2.8-stm32mp-r1(230b4d84)
NOTICE:  BL2: Built : 23:03:15, Sep 18 2023
ERROR:   Could NOT find the fip partition!
ERROR:   BL2: Failure in pre image load handling (-2)
```
Boot works fine when going through USB, so does programming.

### When?
When trying to boot from eMMC

### Cause?
Buswidth was at 8 but no pin definitions were given for 5 to 8,

### Fix

```c
	pinmux = <STM32_PINMUX('A', 8, AF9)>, /* SDMMC2_D4 */
			 <STM32_PINMUX('A', 9, AF10)>, /* SDMMC2_D5 */
			 <STM32_PINMUX('B', 3, AF9)>, /* SDMMC2_D2 */
			 <STM32_PINMUX('B', 4, AF9)>, /* SDMMC2_D3 */
			 <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
			 <STM32_PINMUX('B', 15, AF9)>, /* SDMMC2_D1 */
			 <STM32_PINMUX('D', 3, AF9)>, /* SDMMC2_D7 */
			 <STM32_PINMUX('E', 5, AF9)>; /* SDMMC2_D6 */
```

## Stuck at 'Starting kernel'

To troubleshoot this, first enable lowlevel debugging and early printk in the kernel
```
Symbol: DEBUG_LL
Depends on: DEBUG_KERNEL
Location:
  -> Kernel hacking
    -> arm Debugging
      [*] Kernel low-level debugging functions

Symbol: STM32MP1_DEBUG_UART
Location:
  -> Kernel hacking
    -> arm Debugging
      [*] Kernel low-level debugging functions
        [*] Kernel low-level debugging port
        (X) Use STM32MP1 UART for low-level debug

Symbol: EARLY_PRINTK
Depends on: DEBUG_LL
Location:
  -> Kernel hacking
    -> arm Debugging
      [*] Kernel low-level debugging functions
      [*] Early printk
```

Then alter extlinux.conf (found on the bootfs) to include earlyprintk
    * root=/dev/mmcblk0p6 rootwait rw **earlyprintk** console=ttySTM0,115200`
    
### Issue 1, scmi missing [SOLVED]
```
[    0.199871] cpuidle: using governor menu
[    0.210280] hw-breakpoint: found 5 (+1 reserved) breakpoint and 4 watchpoint registers.
[    0.218341] hw-breakpoint: maximum watchpoint size is 8 bytes.
[    0.224779] Serial: AMBA PL011 UART driver
[    0.231370] stm32-pm-domain pm_domain: domain core-ret-power-domain registered
[    0.238744] stm32-pm-domain pm_domain: subdomain core-power-domain registered
[    0.245927] stm32-pm-domain pm_domain: domains probed
[    0.259010] 8<--- cut here ---
[    0.262103] Unhandled fault: imprecise external abort (0x1c06) at 0xae4a437e
[    0.269191] [ae4a437e] *pgd=00000000
[    0.272801] Internal error: : 1c06 [#1] PREEMPT SMP ARM
```
**Cause** Missing scmi in kernel dts, because it wasn't copy of u-boot?
**Fix**   Use the u-boot dts

### Issue 2, entropy failure [SOLVED]
```
[    1.665708] (NULL device *): TA_CMD_GET_ENTROPY invoke err: ffff000a
[   12.063815] optee-rng optee-ta-ab7a617c-b8e7-4d8f-8301-d09b61036b64: TA_CMD_GET_ENTROPY invoke err: ffff000a
```
#### Cause
Missing node in optee dts.

#### Fix
Either make sure the RNG module is active in CubeMX or manually edit the dts
Add this to the optee dts
```
&rng1{
	status = "okay";

	/* USER CODE BEGIN rng1 */
	/* USER CODE END rng1 */
}; 	
// in the etzpc node
/*"Secured" peripherals*/
DECPROT(STM32MP1_ETZPC_RNG1_ID, DECPROT_S_RW, DECPROT_UNLOCK) // Added rng
```

### Issue 3, bus_type 'tee' not initialized [SOLVED]
```
[    0.402919] Driver 'scmi-optee' was unable to register with bus_type 'tee' because the bus was not initialized.
```
But later in boot you get
```
[    0.440275] optee: probing for conduit method.
[    0.440311] optee: revision 3.19 (afacf356)
[    0.441006] optee: dynamic shared memory is enabled
[    0.442692] optee: initialized driver
```
Confirmed by ST that this can be ignored.
https://community.st.com/t5/stm32-mpus-products/various-issues-when-starting-kernel-on-custom-stm32mp151aac/m-p/614071/highlight/true#M10544

### Issue 4, can't find /dev/disk [SOLVED]
```
Starting systemd-udevd version 253.1^
root '/dev/disk/by-partuuid/491f6117-415d-4f53-88c9-6e0de54deac6' doesn't exist or does not contain a /dev.
```
Relevant info
```
Part    Start LBA       End LBA         Name
        Attributes
        Type GUID
        Partition GUID
  1     0x00000400      0x000007ff      "metadata1"
        attrs:  0x0000000000000000
        type:   8a7a84a0-8387-40f6-ab41-a8b9a5a60d23
                (8a7a84a0-8387-40f6-ab41-a8b9a5a60d23)
        guid:   7acd65d2-7fab-4d12-8608-b1595a77876f
  2     0x00000800      0x00000bff      "metadata2"
        attrs:  0x0000000000000000
        type:   8a7a84a0-8387-40f6-ab41-a8b9a5a60d23
                (8a7a84a0-8387-40f6-ab41-a8b9a5a60d23)
        guid:   c2abdaa4-73f1-40c5-9c6f-01a04d94b731
  3     0x00000c00      0x00002bff      "fip-a"
        attrs:  0x0000000000000000
        type:   19d5df83-11b0-457b-be2c-7559c13142a5
                (19d5df83-11b0-457b-be2c-7559c13142a5)
        guid:   4fd84c93-54ef-463f-a7ef-ae25ff887087
  4     0x00002c00      0x00004bff      "fip-b"
        attrs:  0x0000000000000000
        type:   19d5df83-11b0-457b-be2c-7559c13142a5
                (19d5df83-11b0-457b-be2c-7559c13142a5)
        guid:   09c54952-d5bf-45af-acee-335303766fb3
  5     0x00004c00      0x00004fff      "u-boot-env"
        attrs:  0x0000000000000000
        type:   3de21764-95bd-54bd-a5c3-4abe786f38a8
                (u-boot-env)
        guid:   830e6107-bbc6-4ef0-bfe1-7f2137955d77
  6     0x00005000      0x00024fff      "bootfs"
        attrs:  0x0000000000000004
        type:   0fc63daf-8483-4772-8e79-3d69d8477de4
                (linux)
        guid:   9ff74730-6568-4a18-bebd-eaf318cce82d
  7     0x00025000      0x0002cfff      "vendorfs"
        attrs:  0x0000000000000000
        type:   0fc63daf-8483-4772-8e79-3d69d8477de4
                (linux)
        guid:   eda9384a-8feb-41bf-8716-d9d86bea28b9
  8     0x0002d000      0x00747bff      "rootfs"
        attrs:  0x0000000000000000
        type:   0fc63daf-8483-4772-8e79-3d69d8477de4
                (linux)
        guid:   491f6117-415d-4f53-88c9-6e0de54deac6
```

**This issue has the same cause and solution as issue 5**

### Issue 5, stpmic init [PARTIALLY SOLVED]
```
[    3.365707] stpmic1 0-0033: Failed to get main IRQ: -22
[    3.369655] stpmic1: probe of 0-0033 failed with error -22
[    3.384419] stm32f7-i2c 5c002000.i2c: STM32F7 I2C-0 bus adapter
```
The reason for this is missing interrupt information in the pmic node...
```c
pmic: stpmic@33 {
    ...
    interrupts-extended = <&exti 55 IRQ_TYPE_EDGE_FALLING>;
    interrupt-controller;
    #interrupt-cells = <2>;
    ...
};
```
After adding this, the output becomes
```c
[    3.734803] stpmic1 0-0033: PMIC Chip Version: 0x21
[    3.791026] stpmic1-regulator 5c002000.i2c:stpmic@33:regulators: Failed to create device link (0x180) with 0-0033
[    3.814759] stpmic1-regulator 5c002000.i2c:stpmic@33:regulators: Failed to create device link (0x180) with 0-0033
[    3.823589] stpmic1-regulator 5c002000.i2c:stpmic@33:regulators: Failed to create device link (0x180) with 0-0033
```
Still need to figure out the cause of the failure

### Issue 6, various odd issues [SOLVED]
```
amba 58005000.mmc: deferred probe pending
```
No longer appears after fixing issue 5...

### Issue 7, m4?
The line below is repeated a couple of times
```c
stm32-rproc 10000000.m4: error -ENXIO: IRQ index 0 not found
```
**Cause** Missing interrupt info in the node
**Solution**
Adding the interrupt lines
```c
&m4_rproc{	
	/* USER CODE BEGIN m4_rproc */	
	interrupt-parent = <&exti>;
	interrupts = <68 1>;
	wakeup-source;
	/* USER CODE END m4_rproc */
```
But still got.
```c
[   14.608918] platform 10000000.m4: deferred probe pending
```
### Issue 8
```
[    2.028867] sysfs: cannot create duplicate filename '/devices/platform/cpufreq-dt'
...
[    0.531964] Hardware name: STM32 (Device Tree Support)
[    0.531976] Workqueue: events_unbound deferred_probe_work_func
[    0.532034]  unwind_backtrace from show_stack+0x10/0x14
[    0.532072]  show_stack from dump_stack_lvl+0x40/0x4c
[    0.532106]  dump_stack_lvl from sysfs_warn_dup+0x58/0x64
[    0.532141]  sysfs_warn_dup from sysfs_create_dir_ns+0xf4/0x104
[    0.532170]  sysfs_create_dir_ns from create_dir+0x1c/0x164
[    0.532204]  create_dir from kobject_add_internal+0xa4/0x208
[    0.532239]  kobject_add_internal from kobject_add+0x60/0xc4
[    0.532274]  kobject_add from device_add+0xcc/0x6d4
[    0.532308]  device_add from platform_device_add+0x100/0x244
[    0.532334]  platform_device_add from platform_device_register_full+0x108/0x158
[    0.532361]  platform_device_register_full from stm32_cpufreq_probe+0xfc/0x19c
[    0.532399]  stm32_cpufreq_probe from platform_probe+0x5c/0xb0
[    0.532430]  platform_probe from really_probe+0xe0/0x40c
[    0.532459]  really_probe from __driver_probe_device+0x9c/0x130
[    0.532494]  __driver_probe_device from driver_probe_device+0x30/0xc0
[    0.532530]  driver_probe_device from __device_attach_driver+0xa8/0x120
[    0.532566]  __device_attach_driver from bus_for_each_drv+0x88/0xd4
[    0.532601]  bus_for_each_drv from __device_attach+0xa8/0x1ec
[    0.532634]  __device_attach from bus_probe_device+0x84/0x8c
[    0.532668]  bus_probe_device from deferred_probe_work_func+0x8c/0xd4
[    0.532702]  deferred_probe_work_func from process_one_work+0x1e8/0x510
[    0.532733]  process_one_work from worker_thread+0x208/0x504
[    0.532757]  worker_thread from kthread+0xdc/0xf8
[    0.532790]  kthread from ret_from_fork+0x14/0x2c
[    0.532819] Exception stack(0xde8c9fb0 to 0xde8c9ff8)
[    0.532835] 9fa0:                                     00000000 00000000 00000000 00000000
[    0.532851] 9fc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[    0.532866] 9fe0: 00000000 00000000 00000000 00000000 00000013 00000000
...
[    2.603873] kobject_add_internal failed for cpufreq-dt with -EEXIST, don't try to register things with the same name in the same directory.
```

### Issue 9, missing cpufreq property [SOLVED]
```
[ 0.003188] /cpus/cpu@0 missing clock-frequency property
```
**Solution**
Add/edit the &cpu node (in addons section)
```
&cpu0 {
 	clock-frequency = <650000000>;
	cpu-supply = <&vddcore>;
};
```

### Issue 10, etzpc i2c? [SOLVED]

`stm32_etzpc etzpc@5c007000: i2c@5c009000 not allowed on bus (-13)`
`stm32-sys-bus 5c007000.etzpc: Failed to create device link (0x180) with soc:pinctrl@54004000`

**Solution**
Wasn't mentioned in the etzpc section in optee dts.
`DECPROT(STM32MP1_ETZPC_I2C6_ID, DECPROT_NS_RW, DECPROT_UNLOCK)`

### Issue 11, i2c clock? [SOLVED]

[    3.781517] stm32f7-i2c 5c002000.i2c: STM32F7 I2C-0 bus adapter
[    3.787978] stm32f7-i2c 5c009000.i2c: error -ENOENT: Failed to get controller clock
[    3.801135] stm32f7-i2c: probe of 5c009000.i2c failed with error -2

i2c4 is fine, but i2c6 not.

**Solution**
The following node was missing from the scmi file. Not sure why this is required.
i2c5 seems to work fine without... might be because i2c4 and i2c6 can be used in ROM/tf-a etc, the other ones can't.
```c
&i2c6 {
	clocks = <&scmi_clk CK_SCMI_I2C6>;
	resets = <&scmi_reset RST_SCMI_I2C6>;
};
```

### Issue 12, i2cdetect really slow for certain ports [Solved]

- SCL and SDA idle high
- No error messages in logs

**Cause & Solution**
Something wrong with one of the slaves on the bus, removed it.

### Issue 13, pcf85363, error -6 

```bash
[   19.306485] pcf85363 1-0051: pcf85363_rtc_read_time: error -6
[   19.360313] pcf85363 1-0051: registered as rtc1
```
This method can be found at https://github.com/torvalds/linux/blob/master/drivers/rtc/rtc-pcf85363.c
```c
static int pcf85363_rtc_read_time(struct device *dev, struct rtc_time *tm)
{
	struct pcf85363 *pcf85363 = dev_get_drvdata(dev);
	unsigned char buf[DT_YEARS + 1];
	int ret, len = sizeof(buf);

	/* read the RTC date and time registers all at once */
	ret = regmap_bulk_read(pcf85363->regmap, DT_100THS, buf, len);
	if (ret) {
		dev_err(dev, "%s: error %d\n", __func__, ret);
		return ret;
	}

	tm->tm_year = bcd2bin(buf[DT_YEARS]);
	/* adjust for 1900 base of rtc_time */
	tm->tm_year += 100;

	tm->tm_wday = buf[DT_WEEKDAYS] & 7;
	buf[DT_SECS] &= 0x7F;
	tm->tm_sec = bcd2bin(buf[DT_SECS]);
	buf[DT_MINUTES] &= 0x7F;
	tm->tm_min = bcd2bin(buf[DT_MINUTES]);
	tm->tm_hour = bcd2bin(buf[DT_HOURS]);
	tm->tm_mday = bcd2bin(buf[DT_DAYS]);
	tm->tm_mon = bcd2bin(buf[DT_MONTHS]) - 1;

	return 0;
}
```
regmap_bulk_read can be found in https://elixir.bootlin.com/linux/latest/source/drivers/base/regmap/regmap.c#L3076
The return value of 6 seems to be used for multiple issues...
According to this https://kernel.googlesource.com/pub/scm/linux/kernel/git/nico/archive/+/v0.97/include/linux/errno.h
The 6 refers to "No such device or address", note the fact that `sudo i2cdetect -y 1` shows UU at that address, just
means the driver is looking at it, doesn't mean anything is responding.

**Cause**
RTC broken, needs to be replaced.

### Issue 14, dwmac dma? [Solved]
```
[   27.980199] stm32-dwmac 5800a000.ethernet end0: Register MEM_TYPE_PAGE_POOL RxQ-0
[   28.116452] stm32-dwmac 5800a000.ethernet end0: PHY [stmmac-0:01] driver [SMSC LAN8710/LAN8720] (irq=POLL)
[   29.173563] stm32-dwmac 5800a000.ethernet: Failed to reset the dma
[   29.178376] stm32-dwmac 5800a000.ethernet end0: stmmac_hw_setup: DMA engine initialization failed
[   29.222245] stm32-dwmac 5800a000.ethernet end0: __stmmac_open: Hw setup failed
```
This goes wrong before the kernel has booted. When stopping at u-boot only the green led or none are on.
U-Boot complains of mac not set in OTP (one time programmable fuse).
Manual reset after failed start doesn't work. PHY seems powered down completely (1W total instead of 1,15W)
Before you can enter uboot the ref out is already disabled and high?
The clock output of the PHY is disabled and becomes high??

According to https://wiki.st.com/stm32mpu/wiki/Ethernet_overview#How_to_debug it's a clock issue not a memory one.
So Checked the clocks...
- 25MHz clock to PHY => ok
- 50MHz clock out of PHY => ok
- 50MHz clock in SoM => Not ok 

**Partial solution**
The pad on the SoM was shorted to ground, removing the short solved the issue IF the cable isn't in before power on...


Maybe related? https://community.st.com/t5/stm32-mpus-products/ethernet-fails-if-cable-plugged-in-during-boot-if-plugged-in/td-p/83641 ?
But that's a gbit phy...

Next option was a hardware issue, because not enough bulk capacitance near the eth chip. (was 2x1uF replaced one with 10uF)
This seemed to fix it at first but for some reason only worked three times and then back to how it was.

What was peculiar is that the current draw was lower when things went wrong... and that the ref out clock went high instead of
putting out 25MHz. But seemed to indicate that the phy was stopped, which isn't that odd if startup fails...?

**Solution**
Turns out that the breakout for the rj45 had the leds set up to be draining to the phy instead of sourced from which caused the
state of the regoff to be 0 instead of 1 which means the internal regulator was turned off, which causes both symptoms.